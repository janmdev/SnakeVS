@page "/game/{RoomGuid}"

@using Blazor.Extensions
@using Blazor.Extensions.Canvas
@using Microsoft.AspNetCore.SignalR.Client
@using System.Text.Json
@using Blazor.Extensions.Canvas.Canvas2D
@using MessagePack
@using SnakeVS.Shared

@inject NavigationManager NavigationManager
@inject IJSRuntime jsRuntime
@inject ILoggerFactory LoggerFactory
@inject UserState userState


<PageTitle>Sanke VS</PageTitle>
<p>@userState.UserName</p>
<button @onclick="startGame">START</button>
<div @ref="divCanvas" id="divCanvas">
    <BECanvas @ref="canvas" Height="440" Width="440"></BECanvas>
</div>
@if(roomContext != null && (roomContext.State == GameState.BlueWon || roomContext.State == GameState.RedWon))
{
    <br />
    <button>Leave</button><button @onclick="Reset">Play again</button>
}

@code {
    private HubConnection? hubConnection;
    ElementReference divCanvas;
    protected BECanvasComponent canvas;
    Canvas2DContext canvasContext;
    Room roomContext;
    private Guid roomGuid;

    [Parameter]
    public string? RoomGuid
    {
        get => roomGuid.ToString();
        set => roomGuid = Guid.Parse(value);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        if(hubConnection == null)
        {
            hubConnection = new HubConnectionBuilder()
                .WithUrl(NavigationManager.ToAbsoluteUri($"/gamehub"))
                .AddMessagePackProtocol(options =>
                {
                    options.SerializerOptions =
                        MessagePackSerializerOptions.Standard;//.WithCompression(MessagePackCompression.Lz4BlockArray);
                })
                .Build();
        }
        hubConnection.On<Room>("UpdateRoom", (room_) =>
        {
            roomContext = room_;
            roomContext.FoodList = new List<SnakeFood>(roomContext.FoodArray);
            updateCanvas();
            updatePage();
            InvokeAsync(StateHasChanged);
        });
        await hubConnection.StartAsync();
        await jsRuntime.InvokeVoidAsync("JsFunctions.addKeyboardListenerEvent", DotNetObjectReference.Create(this));
        canvasContext = await canvas.CreateCanvas2DAsync();
        await hubConnection.SendAsync("GetGame", roomGuid);
    }

    private async Task startGame()
    {
        await hubConnection.SendAsync("StartGame", roomGuid);
    }

    private void updatePage()
    {

    }

    private async void updateCanvas()
    {
        await canvasContext.ClearRectAsync(0, 0, 440, 440);
        for (int i = 0; i < 12; i++)
        {
            await canvasContext.SetFillStyleAsync("Black");
            await canvasContext.BeginPathAsync();
            await canvasContext.MoveToAsync(i * 40, 0);
            await canvasContext.LineToAsync(i * 40, 0);
            await canvasContext.LineToAsync(i * 40, 440);
            await canvasContext.ClosePathAsync();
            await canvasContext.StrokeAsync();
        }

        foreach(var food in roomContext.FoodList)
        {
            await canvasContext.SetFillStyleAsync("Yellow");
            await canvasContext.BeginPathAsync();
            //await canvasContext.MoveToAsync(snakeNode.PositionX * 40, snakeNode.PositionY * 40);
            await canvasContext.RectAsync(food.PositionX * 40, food.PositionY * 40, 40, 40);
            await canvasContext.FillAsync();
            await canvasContext.StrokeAsync();
        }

        for (int i = 0; i < 12; i++)
        {
            await canvasContext.SetFillStyleAsync("Black");
            await canvasContext.BeginPathAsync();
            await canvasContext.MoveToAsync(0, i * 40);
            await canvasContext.LineToAsync(0, i * 40);
            await canvasContext.LineToAsync(440, i * 40);
            await canvasContext.ClosePathAsync();
            await canvasContext.StrokeAsync();
        }
        foreach (var snakeNode in roomContext.BlueSnake.Nodes)
        {
            await canvasContext.SetFillStyleAsync("Red");
            await canvasContext.BeginPathAsync();
            //await canvasContext.MoveToAsync(snakeNode.PositionX * 40, snakeNode.PositionY * 40);
            await canvasContext.RectAsync(snakeNode.PositionX * 40, snakeNode.PositionY * 40, 40, 40);
            await canvasContext.FillAsync();
            await canvasContext.StrokeAsync();
            if(snakeNode.IsHead)
            {
                await canvasContext.BeginPathAsync();
                await canvasContext.ArcAsync(snakeNode.PositionX * 40 + 20, snakeNode.PositionY * 40 + 20, 20, 0, 2 * Math.PI);
                await canvasContext.StrokeAsync();
            }
        }

        foreach (var snakeNode in roomContext.RedSnake.Nodes)
        {
            await canvasContext.SetFillStyleAsync("Blue");
            await canvasContext.BeginPathAsync();
            //await canvasContext.MoveToAsync(snakeNode.PositionX * 40, snakeNode.PositionY * 40);
            await canvasContext.RectAsync(snakeNode.PositionX * 40, snakeNode.PositionY * 40, 40, 40);
            await canvasContext.FillAsync();
            await canvasContext.StrokeAsync();
            if(snakeNode.IsHead)
            {
                await canvasContext.BeginPathAsync();
                await canvasContext.ArcAsync(snakeNode.PositionX * 40 + 20, snakeNode.PositionY * 40 + 20, 20, 0, 2 * Math.PI);
                await canvasContext.StrokeAsync();
            }
        }

        await canvasContext.SaveAsync();
    }

    private bool checkGame()
    {
        return (roomContext.BlueSnake.Nodes.Where(p => !p.IsHead).Any(p => p.PositionX == roomContext.BlueSnake.Head.PositionX && p.PositionY == roomContext.BlueSnake.Head.PositionY)) ||
                (roomContext.RedSnake.Nodes.Any(p => p.PositionX == roomContext.BlueSnake.Head.PositionX && p.PositionY == roomContext.BlueSnake.Head.PositionY)) ||
                roomContext.BlueSnake.Head.PositionX < 0 || roomContext.BlueSnake.Head.PositionY < 0 || roomContext.BlueSnake.Head.PositionX > 10 || roomContext.BlueSnake.Head.PositionY > 10;
    }



    [JSInvokable]
    public async ValueTask KeyDown(KeyboardEventArgs e)
    {
        switch (e.Key)
        {
            case "ArrowLeft":
                await hubConnection.SendAsync("SendMove", roomGuid, Direction.Left, Player.Blue);
                break;
            case "ArrowRight":
                await hubConnection.SendAsync("SendMove", roomGuid, Direction.Right, Player.Blue);
                break;
        }
    }

    public async Task Reset()
    {
        await hubConnection.SendAsync("Reset");
    }
}
